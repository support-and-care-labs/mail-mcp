//
// Copyright 2025 The Apache Software Foundation
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

= MCP Server Setup and Usage
ifndef::env-site[:toc:]
ifndef::env-site[:toclevels: 3]

== Overview

The Maven Mail MCP Server provides AI assistants with access to Apache Maven mailing list archives through the Model Context Protocol (MCP). This enables natural language queries about Maven development discussions, decisions, and technical issues.

== Prerequisites

* Docker Desktop (or Podman) with Docker Compose V2
* Claude Code or Claude Desktop (MCP client)

== Quick Start

=== 1. Start All Services

[source,bash]
----
docker compose up -d
----

This starts:

* Elasticsearch for storing and searching emails
* Mail MCP server (Streamable HTTP on port 58080)
* Scheduler for automatic hourly updates

=== 2. Initial Data Retrieval

Before using the MCP, retrieve the mailing list archives:

[source,bash]
----
# Retrieve all dev mailing list archives (2002-present, ~700MB)
for year in $(seq 2002 $(date +%Y)); do
  for month in $(seq -w 1 12); do
    docker compose exec scheduler retrieve-mbox --date ${year}-${month} || true
  done
done

# Index all downloaded mbox files
docker compose exec scheduler index-mbox --directory /app/data/dev/
----

TIP: This initial retrieval takes time but only needs to be done once.
The scheduler container automatically updates the current month's archive hourly.

=== 3. Verify Services

[source,bash]
----
# Check services are running
docker compose ps

# Check mail-mcp health
curl http://localhost:58080/health

# Check Elasticsearch has data
curl http://localhost:59200/maven-dev/_count
----

See xref:data-management.adoc[Data Management] for additional data management options.

== Configuration

=== Environment Variables

Configure the server using environment variables or `.env` file:

[source,bash]
----
# Elasticsearch connection
MAIL_MCP_ELASTICSEARCH_URL=http://localhost:59200
MAIL_MCP_ELASTICSEARCH_INDEX_PREFIX=maven

# Archive URL resolution (default: true)
# When enabled, automatically looks up Pony Mail permalink IDs
# for messages and caches them in Elasticsearch
MAIL_MCP_RESOLVE_ARCHIVE_URLS=true

# Logging
MAIL_MCP_LOG_LEVEL=INFO
----

=== Claude Code Configuration

The MCP server runs as a persistent Docker service and is accessed via Streamable HTTP transport.

[source,bash]
----
claude mcp add maven-mail --transport http http://localhost:58080/mcp
----

NOTE: Ensure the mail-mcp Docker services are running (`docker compose up -d`) before starting Claude Code.

=== Claude Desktop Configuration

To use with Claude Desktop, add to your configuration file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`

**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`

[source,json]
----
{
  "mcpServers": {
    "maven-mail": {
      "type": "streamable-http",
      "url": "http://localhost:58080/mcp"
    }
  }
}
----

NOTE: Ensure the mail-mcp Docker services are running (`docker compose up -d`) before starting Claude Desktop.

== Available Tools

The MCP server provides four tools for querying mailing list archives:

=== search_emails

Full-text search across email archives.

**Parameters:**

* `query` (required): Search query (searches subject and body)
* `list_name` (optional): Mailing list to search (default: dev@maven.apache.org)
* `from_date` (optional): Start date filter (ISO format: YYYY-MM-DD)
* `to_date` (optional): End date filter (ISO format: YYYY-MM-DD)
* `has_jira` (optional): Filter for emails with JIRA references
* `has_vote` (optional): Filter for emails with votes
* `size` (optional): Maximum results (default: 10, max: 100)

**Example queries:**

----
"Search for emails about Maven 4.0 release"
"Find discussions about dependency resolution from 2024"
"Show votes about the build cache feature"
----

=== get_message

Retrieve a specific email message by Message-ID.

**Parameters:**

* `message_id` (required): Message-ID to retrieve
* `list_name` (optional): Mailing list name (default: dev@maven.apache.org)

**Example:**

----
"Show me the email with ID <abc123@example.com>"
----

=== get_thread

Retrieve an entire email thread containing a specific message.

**Parameters:**

* `message_id` (required): Message-ID of any message in the thread
* `list_name` (optional): Mailing list name (default: dev@maven.apache.org)
* `max_messages` (optional): Maximum messages to retrieve (default: 50)

**Example:**

----
"Get the full thread for message <abc123@example.com>"
"Show me the discussion thread about MNG-1234"
----

=== find_references

Find emails referencing a specific JIRA issue or GitHub PR.

**Parameters:**

* `reference` (required): Reference to search for (e.g., "MNG-1234" or "567")
* `reference_type` (optional): Type of reference ("jira" or "github_pr", default: "jira")
* `list_name` (optional): Mailing list name (default: dev@maven.apache.org)
* `size` (optional): Maximum results (default: 20, max: 100)

**Example queries:**

----
"Find all discussions about MNG-1234"
"Show emails mentioning GitHub PR #567"
----

== Usage Examples

Once configured in Claude Desktop, you can use natural language to query the archives:

=== Search Examples

----
"What were the main discussions about Maven 4.0 in 2024?"
"Find recent decisions about the build cache"
"Show me emails where people voted on the wrapper feature"
"Search for discussions about dependency resolution performance"
----

=== Reference Examples

----
"What's the status of MNG-1234?"
"Show all discussions about MRESOLVER-567"
"Find emails related to GitHub PR #123"
----

=== Thread Examples

----
"Show me the full discussion thread about the Maven 4 release"
"Get the conversation that led to the decision on feature X"
----

== Data and Metadata

The MCP server provides rich metadata extraction:

* **JIRA references**: Automatic extraction of Maven JIRA issues (MNG-1234, etc.)
* **GitHub references**: PR numbers and commit SHAs
* **Version numbers**: Mentioned versions (4.0.0, 3.9.0-alpha-1, etc.)
* **Decision indicators**: Keywords like "decided", "consensus", "approved"
* **Vote detection**: Identifies [VOTE] threads and +1/-1 votes
* **Quote filtering**: Separates quoted content from original contributions
* **Archive URLs**: Direct links to emails at https://lists.apache.org (when cached)

=== Archive URLs

When available, search results include an `Archive:` field with a direct link to the email at https://lists.apache.org.
This allows viewing the original email in the Apache Pony Mail web interface.

==== Automatic Resolution (Default)

By default, archive URLs are resolved automatically when using the `get_message` tool.
When you retrieve a specific message:

1. The system checks if an archive URL is already cached
2. If not cached, it queries the Pony Mail API to look up the permalink ID
3. The result is cached in Elasticsearch for future use
4. The archive URL is displayed in the response

This behavior is controlled by the `MAIL_MCP_RESOLVE_ARCHIVE_URLS` environment variable (default: `true`).
Set to `false` to disable automatic resolution.

NOTE: Search results (`search_emails`, `find_references`, etc.) only display cached archive URLs.
Use `get_message` on a specific email to trigger automatic resolution.

==== Manual Resolution

If automatic resolution is disabled, you can still populate the cache programmatically:

[source,python]
----
import asyncio
from datetime import datetime
from mail_mcp.ponymail import PonymailResolver
from mail_mcp.storage.elasticsearch import ElasticsearchClient

async def cache_archive_url():
    es = ElasticsearchClient()
    await es.connect()

    resolver = PonymailResolver(es)
    url = await resolver.resolve_url(
        message_id='<message-id@example.org>',
        list_name='dev@maven.apache.org',
        date=datetime(2024, 10, 1),  # approximate date
        subject='Email subject for search'
    )
    print(f'Archive URL: {url}')
    await es.close()

asyncio.run(cache_archive_url())
----

Once cached, the Archive URL will appear in all MCP tool outputs for that message.

See xref:development:adr/0003-archive-url-resolution.adoc[ADR-0003] for technical details on the URL resolution strategy.

== Troubleshooting

=== Server Won't Connect

Check that Docker services are running:

[source,bash]
----
# Check service status
docker compose ps

# Check mail-mcp logs
docker compose logs mail-mcp

# Check health endpoint
curl http://localhost:58080/health
----

Common issues:

1. **Docker services not running**: Start with `docker compose up -d`
2. **Port conflict**: Ensure port 58080 is not in use by another application
3. **Elasticsearch not healthy**: Wait for Elasticsearch to fully start

=== No Results Found

1. **Check if data is indexed**:
+
[source,bash]
----
curl http://localhost:59200/maven-dev/_count
----

2. **Verify index name**: Default is `maven-dev` for dev@maven.apache.org

3. **Index data if missing**:
+
[source,bash]
----
docker compose exec scheduler index-mbox --directory /app/data/dev/
----

=== Connection Errors

1. **Verify all services are running**:
+
[source,bash]
----
docker compose ps
----

2. **Verify Elasticsearch is accessible**:
+
[source,bash]
----
curl http://localhost:59200/_cluster/health
----

3. **Check mail-mcp logs for errors**:
+
[source,bash]
----
docker compose logs --tail=50 mail-mcp
----

=== Session Errors After Server Restart

If you receive HTTP 404 errors with message "Invalid or expired session ID" after restarting the server (e.g., `docker compose restart mail-mcp`), this is expected behavior.

**Cause**: The Streamable HTTP transport uses in-memory session tracking.
When the server restarts, all session state is lost.
Clients that send a stale `mcp-session-id` header will receive a 404 error.

**Solution**: MCP clients should handle 404 responses by re-initializing their session:

. Detect the 404 "Invalid or expired session ID" response
. Discard the stale session ID
. Send a new `initialize` request without the `mcp-session-id` header
. Continue with the new session

NOTE: This is standard MCP protocol behavior.
Well-implemented clients should automatically recover from session loss.

== Performance Considerations

* **Batch size**: Default 100 documents per batch for indexing
* **Search limits**: Default 10 results, max 100 per query
* **Thread limits**: Default 50 messages, configurable
* **Cache**: Elasticsearch handles caching automatically

For large-scale deployments, see xref:development:development.adoc#performance-optimization[Performance Optimization].

== Security Notes

* The MCP server runs locally and connects to local Elasticsearch
* No external network access required (after initial data retrieval)
* All communication stays on localhost
* No authentication currently implemented (local-only access)

== Related Documentation

* xref:development:development.adoc[Development Guide]
* xref:data-management.adoc[Data Management]
* xref:development:roadmap.adoc[Roadmap and Features]
* https://modelcontextprotocol.io/[Model Context Protocol Specification]
